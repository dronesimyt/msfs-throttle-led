<head>
  <meta charset="utf-8" />
  <title>MSFS Throttle LED</title>
</head>

<body style="margin: 0; padding: 0; overflow: hidden">
  <canvas id="c"></canvas>
</body>

<script>
  const c = document.getElementById("c");
  const ctx = c.getContext("2d");

  let thr = 0; // 0..100

  // Event semantics:
  // C1 = BAR color
  // C2 = BACKGROUND color
  let barColor = [255, 0, 0];
  let bgColor = [0, 0, 255];

  // DESIGN
  const PULSE_BG = false; // set true if you want subtle pulsing
  const DRAW_THREE_BARS = true; // keep your 3 bars look

  const BAR_X = 0.0;
  const BAR_W = 1.0;
  const BAR_H = 0.07;
  const GAP = 0.02;
  const START_Y = 0.55;

  function clamp255(x) {
    x = Number(x) || 0;
    return x < 0 ? 0 : x > 255 ? 255 : x;
  }

  function handleEvent(evStr) {
    let s = String(evStr ?? "");

    // Safe to keep: if SignalRGB ever passes encoded strings, this still works.
    try {
      s = decodeURIComponent(s);
    } catch (e) {}

    // THR=<float>
    let m = s.match(/THR=(\d+(\.\d+)?)/);
    if (m) {
      const v = parseFloat(m[1]);
      if (!Number.isNaN(v)) thr = Math.max(0, Math.min(100, v));
      return;
    }

    // C1/C2=R,G,B (tolerates spaces)
    m = s.match(/C([12])\s*=\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/);
    if (m) {
      const rgb = [
        clamp255(parseInt(m[2], 10)),
        clamp255(parseInt(m[3], 10)),
        clamp255(parseInt(m[4], 10)),
      ];
      if (m[1] === "1") barColor = rgb;
      else bgColor = rgb;
    }
  }

  // SignalRGB callback
  function onCanvasApiEvent(apiEvent) {
    try {
      if (apiEvent && typeof apiEvent === "object") {
        handleEvent(apiEvent.event);
      } else {
        handleEvent(apiEvent);
      }
    } catch (e) {
      // stay silent in production
    }
  }
  window.onCanvasApiEvent = onCanvasApiEvent;

  function drawBackground(W, H) {
    let [r, g, b] = bgColor;

    if (PULSE_BG) {
      const t = Date.now() / 1000;
      const mult = 0.85 + 0.15 * (Math.sin(t * 1.5) * 0.5 + 0.5);
      r = clamp255(Math.round(r * mult));
      g = clamp255(Math.round(g * mult));
      b = clamp255(Math.round(b * mult));
    }

    ctx.fillStyle = `rgb(${r},${g},${b})`;
    ctx.fillRect(0, 0, W, H);
  }

  function drawBar(W, H, nx, ny, nw, nh, frac) {
    const x = Math.round(nx * W);
    const y = Math.round(ny * H);
    const w = Math.max(1, Math.round(nw * W));
    const h = Math.max(1, Math.round(nh * H));

    const fillW = Math.round(w * frac);

    ctx.fillStyle = `rgb(${barColor[0]},${barColor[1]},${barColor[2]})`;
    ctx.fillRect(x, y, fillW, h);

    ctx.strokeStyle = "rgba(255,255,255,0.15)";
    ctx.strokeRect(x, y, w, h);
  }

  function loop() {
    const W = Math.max(1, typeof screenWidth === "number" ? screenWidth : 320);
    const H = Math.max(1, typeof screenHeight === "number" ? screenHeight : 200);
    c.width = W;
    c.height = H;

    drawBackground(W, H);

    const frac = thr / 100;

    if (DRAW_THREE_BARS) {
      drawBar(W, H, BAR_X, START_Y + 0 * (BAR_H + GAP), BAR_W, BAR_H, frac);
      drawBar(W, H, BAR_X, START_Y + 1 * (BAR_H + GAP), BAR_W, BAR_H, frac);
      drawBar(W, H, BAR_X, START_Y + 2 * (BAR_H + GAP), BAR_W, BAR_H, frac);
    } else {
      drawBar(W, H, 0.0, 0.62, 1.0, 0.25, frac);
    }

    requestAnimationFrame(loop);
  }

  requestAnimationFrame(loop);
</script>
